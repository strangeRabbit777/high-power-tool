<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Mocha Tests</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="../node_modules/mocha/mocha.css" />
</head>
<body>
<div id="mocha"></div>
<script src="../node_modules/chai/chai.js"></script>
<script src="../node_modules/mocha/mocha.js"></script>
<script src="../node_modules/sinon/pkg/sinon.js"></script>
<script src="../src/htmx.js"></script>
<script class="mocha-init">
    mocha.setup('bdd');
    mocha.checkLeaks();
    should = chai.should();
</script>

<script>
    /* Utilities */
    function byId(id) {
        return document.getElementById(id);
    }

    function make(htmlStr) {
        let range = document.createRange();
        let fragment = range.createContextualFragment(htmlStr);
        for (let i = fragment.children.length - 1; i >= 0; i--) {
            const child = fragment.children[i];
            HTMx.processElement(child);
            document.body.appendChild(child);
        }
        return document.body.lastChild;
    }
</script>

<script>
    describe("Core HTMx Tests", function(){
        beforeEach(function() {
            this.server = sinon.fakeServer.create();
        });
        afterEach(function()  {
            this.server.restore();
        });

        // bootstrap test
        it('issues a GET request on click and swaps content', function() {
            let btn = make('<button hx-get="/test1">Click Me!</button>')
            this.server.respondWith("GET", "/test1", "Clicked!");
            btn.click();
            this.server.respond();
            btn.innerHTML.should.equal("Clicked!");
        });

        it('processes inner content properly', function() {
            let div = make('<div hx-get="/test2"></div>')
            this.server.respondWith("GET", "/test2", '<a hx-get="/test2_2">Click Me</a>');
            this.server.respondWith("GET", "/test2_2", "Clicked!");
            div.click();
            this.server.respond();
            div.innerHTML.should.equal('<a hx-get="/test2_2">Click Me</a>');
            let a = div.querySelector('a');
            a.click();
            this.server.respond();
            a.innerHTML.should.equal('Clicked!');
        });

        it('handles swap outerHTML properly', function() {
            let div = make('<div id="div-outer-html-test" hx-get="/test3" hx-swap="outerHTML"></div>')
            this.server.respondWith("GET", "/test3", '<a id="a-outer-html-test" hx-get="/test3_2">Click Me</a>');
            this.server.respondWith("GET", "/test3_2", "Clicked!");
            div.click();
            should.equal(byId("div-outer-html-test"), div);
            this.server.respond();
            should.equal(byId("div-outer-html-test"), null);
            byId("a-outer-html-test").click();
            this.server.respond();
            byId("a-outer-html-test").innerHTML.should.equal('Clicked!');
        });

    })
</script>

<script class="mocha-exec">
    mocha.run();
</script>
</body>
</html>
